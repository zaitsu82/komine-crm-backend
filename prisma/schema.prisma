generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// メインテーブル: Plot（区画）
model Plot {
  id            String    @id @default(uuid()) @map("plot_id")
  plot_number   String    @unique @db.VarChar(20)
  section       String    @db.VarChar(50)
  usage         String    @db.VarChar(20) // in_use, available, reserved
  size          String    @db.VarChar(50)
  price         String    @db.VarChar(50)
  contract_date DateTime? @db.Date
  status        String    @default("active") @db.VarChar(20) // active, inactive
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  deleted_at    DateTime?

  // Relations
  Applicant        Applicant?
  Contractors      Contractor[]
  UsageFee         UsageFee?
  ManagementFee    ManagementFee?
  GravestoneInfo   GravestoneInfo?
  FamilyContacts   FamilyContact[]
  EmergencyContact EmergencyContact?
  BuriedPersons    BuriedPerson[]

  @@index([plot_number])
  @@index([usage, section])
  @@index([deleted_at])
  @@map("plots")
}

// 申込者情報
model Applicant {
  id               String    @id @default(uuid()) @map("applicant_id")
  plot_id          String    @unique
  application_date DateTime? @db.Date
  staff_name       String    @db.VarChar(100)
  name             String    @db.VarChar(100)
  name_kana        String    @db.VarChar(100)
  postal_code      String    @db.VarChar(8)
  phone_number     String    @db.VarChar(15)
  address          String    @db.VarChar(200)
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt
  deleted_at       DateTime?

  // Relations
  Plot Plot @relation(fields: [plot_id], references: [id], onDelete: Cascade)

  @@index([plot_id])
  @@map("applicants")
}

// 契約者情報
model Contractor {
  id                 String    @id @default(uuid()) @map("contractor_id")
  plot_id            String
  reservation_date   DateTime? @db.Date
  acceptance_number  String?   @db.VarChar(50)
  permit_date        DateTime? @db.Date
  start_date         DateTime? @db.Date
  name               String    @db.VarChar(100)
  name_kana          String    @db.VarChar(100)
  birth_date         DateTime? @db.Date
  gender             String?   @db.VarChar(10)
  phone_number       String    @db.VarChar(15)
  fax_number         String?   @db.VarChar(15)
  email              String?   @db.VarChar(100)
  address            String    @db.VarChar(200)
  registered_address String?   @db.VarChar(200)
  created_at         DateTime  @default(now())
  updated_at         DateTime  @updatedAt
  deleted_at         DateTime?

  // Relations
  Plot        Plot         @relation(fields: [plot_id], references: [id], onDelete: Cascade)
  WorkInfo    WorkInfo?
  BillingInfo BillingInfo?

  @@index([plot_id])
  @@index([name, name_kana])
  @@map("contractors")
}

// 使用料
model UsageFee {
  id               String    @id @default(uuid()) @map("usage_fee_id")
  plot_id          String    @unique
  calculation_type String    @db.VarChar(20)
  tax_type         String    @db.VarChar(20)
  billing_type     String    @db.VarChar(20)
  billing_years    String    @db.VarChar(20)
  area             String    @db.VarChar(50)
  unit_price       String    @db.VarChar(50)
  usage_fee        String    @db.VarChar(50)
  payment_method   String    @db.VarChar(20)
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt
  deleted_at       DateTime?

  // Relations
  Plot Plot @relation(fields: [plot_id], references: [id], onDelete: Cascade)

  @@index([plot_id])
  @@map("usage_fees")
}

// 管理料
model ManagementFee {
  id                 String    @id @default(uuid()) @map("management_fee_id")
  plot_id            String    @unique
  calculation_type   String    @db.VarChar(20)
  tax_type           String    @db.VarChar(20)
  billing_type       String    @db.VarChar(20)
  billing_years      String    @db.VarChar(20)
  area               String    @db.VarChar(50)
  billing_month      String    @db.VarChar(20)
  management_fee     String    @db.VarChar(50)
  unit_price         String    @db.VarChar(50)
  last_billing_month String    @db.VarChar(20)
  payment_method     String    @db.VarChar(20)
  created_at         DateTime  @default(now())
  updated_at         DateTime  @updatedAt
  deleted_at         DateTime?

  // Relations
  Plot Plot @relation(fields: [plot_id], references: [id], onDelete: Cascade)

  @@index([plot_id])
  @@map("management_fees")
}

// 墓石情報
model GravestoneInfo {
  id                     String    @id @default(uuid()) @map("gravestone_info_id")
  plot_id                String    @unique
  gravestone_base        String    @db.VarChar(100)
  enclosure_position     String    @db.VarChar(100)
  gravestone_dealer      String    @db.VarChar(100)
  gravestone_type        String    @db.VarChar(50)
  surrounding_area       String    @db.VarChar(100)
  establishment_deadline DateTime? @db.Date
  establishment_date     DateTime? @db.Date
  created_at             DateTime  @default(now())
  updated_at             DateTime  @updatedAt
  deleted_at             DateTime?

  // Relations
  Plot Plot @relation(fields: [plot_id], references: [id], onDelete: Cascade)

  @@index([plot_id])
  @@map("gravestone_infos")
}

// 家族・連絡先
model FamilyContact {
  id                 String    @id @default(uuid()) @map("family_contact_id")
  plot_id            String
  name               String    @db.VarChar(100)
  birth_date         DateTime? @db.Date
  relationship       String    @db.VarChar(50)
  address            String    @db.VarChar(200)
  phone_number       String    @db.VarChar(15)
  fax_number         String?   @db.VarChar(15)
  email              String?   @db.VarChar(100)
  registered_address String?   @db.VarChar(200)
  mailing_type       String?   @db.VarChar(20) // home, work, other
  company_name       String?   @db.VarChar(100)
  company_name_kana  String?   @db.VarChar(100)
  company_address    String?   @db.VarChar(200)
  company_phone      String?   @db.VarChar(15)
  notes              String?
  created_at         DateTime  @default(now())
  updated_at         DateTime  @updatedAt
  deleted_at         DateTime?

  // Relations
  Plot Plot @relation(fields: [plot_id], references: [id], onDelete: Cascade)

  @@index([plot_id])
  @@map("family_contacts")
}

// 緊急連絡先
model EmergencyContact {
  id           String    @id @default(uuid()) @map("emergency_contact_id")
  plot_id      String    @unique
  name         String    @db.VarChar(100)
  relationship String    @db.VarChar(50)
  phone_number String    @db.VarChar(15)
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt
  deleted_at   DateTime?

  // Relations
  Plot Plot @relation(fields: [plot_id], references: [id], onDelete: Cascade)

  @@index([plot_id])
  @@map("emergency_contacts")
}

// 埋葬者一覧
model BuriedPerson {
  id           String    @id @default(uuid()) @map("buried_person_id")
  plot_id      String
  name         String    @db.VarChar(100)
  name_kana    String?   @db.VarChar(100)
  relationship String?   @db.VarChar(50)
  death_date   DateTime? @db.Date
  age          Int?
  gender       String?   @db.VarChar(10)
  burial_date  DateTime? @db.Date
  memo         String?
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt
  deleted_at   DateTime?

  // Relations
  Plot Plot @relation(fields: [plot_id], references: [id], onDelete: Cascade)

  @@index([plot_id])
  @@map("buried_persons")
}

// 勤務先・連絡情報
model WorkInfo {
  id                String    @id @default(uuid()) @map("work_info_id")
  contractor_id     String    @unique
  company_name      String    @db.VarChar(100)
  company_name_kana String    @db.VarChar(100)
  work_address      String    @db.VarChar(200)
  work_postal_code  String    @db.VarChar(8)
  work_phone_number String    @db.VarChar(15)
  dm_setting        String    @db.VarChar(20) // allow, deny, limited
  address_type      String    @db.VarChar(20) // home, work, other
  notes             String?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  deleted_at        DateTime?

  // Relations
  Contractor Contractor @relation(fields: [contractor_id], references: [id], onDelete: Cascade)

  @@index([contractor_id])
  @@map("work_infos")
}

// 請求情報
model BillingInfo {
  id             String    @id @default(uuid()) @map("billing_info_id")
  contractor_id  String    @unique
  billing_type   String    @db.VarChar(20) // individual, corporate, bank_transfer
  bank_name      String    @db.VarChar(100)
  branch_name    String    @db.VarChar(100)
  account_type   String    @db.VarChar(20) // ordinary, current, savings
  account_number String    @db.VarChar(50)
  account_holder String    @db.VarChar(100)
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt
  deleted_at     DateTime?

  // Relations
  Contractor Contractor @relation(fields: [contractor_id], references: [id], onDelete: Cascade)

  @@index([contractor_id])
  @@map("billing_infos")
}

// 更新履歴テーブル
model History {
  id             String   @id @default(uuid()) @map("history_id")
  entity_type    String   @db.VarChar(50) // テーブル名: Plot, Applicant, Contractor など
  entity_id      String   @db.VarChar(255) // 対象レコードのID
  plot_id        String? // 関連する区画ID（検索用）
  action_type    String   @db.VarChar(20) // CREATE, UPDATE, DELETE
  changed_fields Json? // 変更されたフィールド名のリスト例: ["plot_number", "section"]
  changed_by     String?  @db.VarChar(100) // 変更者（Staff IDまたは名前）
  change_reason  String?  @db.VarChar(200) // 変更理由
  ip_address     String?  @db.VarChar(50) // 変更元IPアドレス
  created_at     DateTime @default(now())

  @@index([entity_type, entity_id])
  @@index([plot_id])
  @@index([created_at])
  @@index([changed_by])
  @@map("histories")
}

model Staff {
  id            Int       @id @default(autoincrement()) @map("staff_id")
  name          String    @db.VarChar(100)
  email         String    @unique @db.VarChar(100)
  password      String    @db.VarChar(255)
  role          String    @default("viewer") @db.VarChar(20) // viewer, operator, manager, admin
  is_active     Boolean   @default(true)
  last_login_at DateTime?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  @@index([email])
  @@index([role, is_active])
  @@map("staff")
}

// マスタテーブル
model UsageStatusMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("usage_status_master")
}

model CemeteryTypeMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("cemetery_type_master")
}

model DenominationMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("denomination_master")
}

model GenderMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("gender_master")
}

model PaymentMethodMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("payment_method_master")
}

model TaxTypeMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  tax_rate    Decimal? @db.Decimal(5, 2)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("tax_type_master")
}

model CalcTypeMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("calc_type_master")
}

model BillingTypeMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("billing_type_master")
}

model AccountTypeMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("account_type_master")
}

model RecipientTypeMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("recipient_type_master")
}

model RelationMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("relation_master")
}

model ConstructionTypeMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("construction_type_master")
}

model UpdateTypeMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("update_type_master")
}

model PrefectureMaster {
  id         Int      @id @default(autoincrement())
  code       String   @unique @db.VarChar(2)
  name       String   @db.VarChar(10)
  name_kana  String?  @db.VarChar(20)
  sort_order Int?
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("prefecture_master")
}
