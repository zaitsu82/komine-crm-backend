generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// メインテーブル
model Gravestone {
  id                    Int              @id @default(autoincrement()) @map("gravestone_id")
  gravestone_code       String           @unique @db.VarChar(20)
  usage_status          String           @db.VarChar(20)
  price                 Decimal          @db.Decimal(10, 2)
  orientation           String?          @db.VarChar(10)
  location              String?          @db.VarChar(100)
  cemetery_type         String?          @db.VarChar(20)
  denomination          String?          @db.VarChar(20)
  inscription           String?
  construction_deadline DateTime?        @db.Date
  construction_date     DateTime?        @db.Date
  epitaph               String?
  remarks               String?
  deleted_at            DateTime?
  created_at            DateTime         @default(now())
  updated_at            DateTime         @updatedAt
  
  // Relations
  Applicant             Applicant?
  Contractors           Contractor[]
  UsageFees             UsageFee[]
  ManagementFees        ManagementFee[]
  BillingInfos          BillingInfo[]
  FamilyContacts        FamilyContact[]
  Burials               Burial[]
  Constructions         Construction[]
  Histories             History[]

  @@map("gravestones")
  @@index([gravestone_code])
  @@index([usage_status, cemetery_type])
  @@index([deleted_at])
}

model Applicant {
  id                     Int       @id @default(autoincrement()) @map("applicant_id")
  gravestone_id          Int       @unique
  application_date       DateTime  @db.Date
  staff_name             String?   @db.VarChar(50)
  name                   String    @db.VarChar(100)
  kana                   String    @db.VarChar(100)
  postal_code            String    @db.VarChar(8)
  address                String    @db.VarChar(200)
  phone                  String    @db.VarChar(15)
  remarks                String?
  effective_start_date   DateTime? @db.Date
  effective_end_date     DateTime? @db.Date
  deleted_at             DateTime?
  
  // Relations
  Gravestone Gravestone @relation(fields: [gravestone_id], references: [id], onDelete: Cascade)

  @@map("applicants")
}

model Contractor {
  id                     Int              @id @default(autoincrement()) @map("contractor_id")
  gravestone_id          Int
  reservation_date       DateTime?        @db.Date
  consent_form_number    String?          @db.VarChar(50)
  permission_date        DateTime?        @db.Date
  start_date             DateTime         @db.Date
  name                   String           @db.VarChar(100)
  kana                   String           @db.VarChar(100)
  birth_date             DateTime?        @db.Date
  gender                 String?          @db.VarChar(10)
  postal_code            String           @db.VarChar(8)
  address                String           @db.VarChar(200)
  phone                  String           @db.VarChar(15)
  fax                    String?          @db.VarChar(15)
  email                  String?          @db.VarChar(100)
  domicile_address       String?          @db.VarChar(200)
  workplace_name         String?          @db.VarChar(100)
  workplace_kana         String?          @db.VarChar(100)
  workplace_address      String?          @db.VarChar(200)
  workplace_phone        String?          @db.VarChar(15)
  dm_setting             String?          @db.VarChar(20)
  recipient_type         String?          @db.VarChar(20)
  remarks                String?
  effective_start_date   DateTime?        @db.Date
  effective_end_date     DateTime?        @db.Date
  deleted_at             DateTime?
  
  // Relations
  Gravestone      Gravestone      @relation(fields: [gravestone_id], references: [id], onDelete: Cascade)
  BillingInfos    BillingInfo[]
  FamilyContacts  FamilyContact[]
  Burials         Burial[]
  Histories       History[]

  @@map("contractors")
}

model UsageFee {
  id                   Int       @id @default(autoincrement()) @map("usage_fee_id")
  gravestone_id        Int
  calc_type            String?   @db.VarChar(20)
  area                 Decimal?  @db.Decimal(10, 2)
  fee                  Decimal   @db.Decimal(10, 2)
  tax_type             String?   @db.VarChar(20)
  billing_years        Int?
  unit_price           Decimal?  @db.Decimal(10, 2)
  payment_method       String?   @db.VarChar(20)
  remarks              String?
  effective_start_date DateTime? @db.Date
  effective_end_date   DateTime? @db.Date
  deleted_at           DateTime?
  
  // Relations
  Gravestone Gravestone @relation(fields: [gravestone_id], references: [id], onDelete: Cascade)

  @@map("usage_fees")
}

model ManagementFee {
  id                   Int       @id @default(autoincrement()) @map("management_fee_id")
  gravestone_id        Int
  calc_type            String?   @db.VarChar(20)
  billing_type         String?   @db.VarChar(20)
  area                 Decimal?  @db.Decimal(10, 2)
  fee                  Decimal   @db.Decimal(10, 2)
  last_billing_date    DateTime? @db.Date
  tax_type             String?   @db.VarChar(20)
  billing_years        Int?
  billing_month        Int?
  unit_price           Decimal?  @db.Decimal(10, 2)
  payment_method       String    @db.VarChar(20)
  remarks              String?
  effective_start_date DateTime? @db.Date
  effective_end_date   DateTime? @db.Date
  deleted_at           DateTime?
  
  // Relations
  Gravestone Gravestone @relation(fields: [gravestone_id], references: [id], onDelete: Cascade)

  @@map("management_fees")
}

model BillingInfo {
  id                   Int       @id @default(autoincrement()) @map("billing_info_id")
  gravestone_id        Int
  contractor_id        Int
  billing_type         String?   @db.VarChar(20)
  bank_name            String?   @db.VarChar(50)
  branch_name          String?   @db.VarChar(50)
  account_type         String?   @db.VarChar(20)
  account_number       String?   @db.VarChar(20)
  account_holder       String?   @db.VarChar(100)
  remarks              String?
  effective_start_date DateTime? @db.Date
  effective_end_date   DateTime? @db.Date
  deleted_at           DateTime?
  
  // Relations
  Gravestone Gravestone @relation(fields: [gravestone_id], references: [id], onDelete: Cascade)
  Contractor Contractor @relation(fields: [contractor_id], references: [id], onDelete: Cascade)

  @@map("billing_infos")
}

model FamilyContact {
  id                   Int       @id @default(autoincrement()) @map("family_contact_id")
  gravestone_id        Int
  contractor_id        Int
  name                 String?   @db.VarChar(100)
  birth_date           DateTime? @db.Date
  relation             String?   @db.VarChar(20)
  phone                String?   @db.VarChar(15)
  fax                  String?   @db.VarChar(15)
  email                String?   @db.VarChar(100)
  address              String?   @db.VarChar(200)
  domicile_address     String?   @db.VarChar(200)
  recipient_type       String?   @db.VarChar(20)
  workplace_name       String?   @db.VarChar(100)
  workplace_kana       String?   @db.VarChar(100)
  workplace_address    String?   @db.VarChar(200)
  workplace_phone      String?   @db.VarChar(15)
  remarks              String?
  effective_start_date DateTime? @db.Date
  effective_end_date   DateTime? @db.Date
  deleted_at           DateTime?
  
  // Relations
  Gravestone Gravestone @relation(fields: [gravestone_id], references: [id], onDelete: Cascade)
  Contractor Contractor @relation(fields: [contractor_id], references: [id], onDelete: Cascade)

  @@map("family_contacts")
}

model Burial {
  id                   Int       @id @default(autoincrement()) @map("burial_id")
  gravestone_id        Int
  contractor_id        Int
  name                 String?   @db.VarChar(100)
  kana                 String?   @db.VarChar(100)
  birth_date           DateTime? @db.Date
  gender               String?   @db.VarChar(10)
  posthumous_name      String?   @db.VarChar(100)
  death_date           DateTime? @db.Date
  age_at_death         Int?
  burial_date          DateTime? @db.Date
  notification_date    DateTime? @db.Date
  denomination         String?   @db.VarChar(20)
  remarks              String?
  effective_start_date DateTime? @db.Date
  effective_end_date   DateTime? @db.Date
  deleted_at           DateTime?
  
  // Relations
  Gravestone Gravestone @relation(fields: [gravestone_id], references: [id], onDelete: Cascade)
  Contractor Contractor @relation(fields: [contractor_id], references: [id], onDelete: Cascade)

  @@map("burials")
}

model Construction {
  id                   Int       @id @default(autoincrement()) @map("construction_id")
  gravestone_id        Int
  contractor_name      String?   @db.VarChar(100)
  start_date           DateTime? @db.Date
  planned_end_date     DateTime? @db.Date
  end_date             DateTime? @db.Date
  description          String?
  cost                 Decimal?  @db.Decimal(10, 2)
  payment_amount       Decimal?  @db.Decimal(10, 2)
  construction_type    String?   @db.VarChar(20)
  remarks              String?
  deleted_at           DateTime?
  
  // Relations
  Gravestone Gravestone @relation(fields: [gravestone_id], references: [id], onDelete: Cascade)

  @@map("constructions")
}

model History {
  id                 Int       @id @default(autoincrement()) @map("history_id")
  gravestone_id      Int
  contractor_id      Int
  before_record_id   Int?
  after_record_id    Int?
  update_type        String?   @db.VarChar(20)
  update_reason      String?   @db.VarChar(100)
  updated_by         String?   @db.VarChar(50)
  updated_at         DateTime  @default(now())
  
  // Relations
  Gravestone Gravestone @relation(fields: [gravestone_id], references: [id], onDelete: Cascade)
  Contractor Contractor @relation(fields: [contractor_id], references: [id], onDelete: Cascade)

  @@map("histories")
}

model Staff {
  id              Int       @id @default(autoincrement()) @map("staff_id")
  name            String    @db.VarChar(100)
  email           String    @unique @db.VarChar(100)
  password        String    @db.VarChar(255)
  role            String    @default("viewer") @db.VarChar(20) // viewer, operator, manager, admin
  is_active       Boolean   @default(true)
  last_login_at   DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  @@map("staff")
  @@index([email])
  @@index([role, is_active])
}

// マスタテーブル
model UsageStatusMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("usage_status_master")
}

model CemeteryTypeMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("cemetery_type_master")
}

model DenominationMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("denomination_master")
}

model GenderMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("gender_master")
}

model PaymentMethodMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("payment_method_master")
}

model TaxTypeMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  tax_rate    Decimal? @db.Decimal(5, 2)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("tax_type_master")
}

model CalcTypeMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("calc_type_master")
}

model BillingTypeMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("billing_type_master")
}

model AccountTypeMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("account_type_master")
}

model RecipientTypeMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("recipient_type_master")
}

model RelationMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("relation_master")
}

model ConstructionTypeMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("construction_type_master")
}

model UpdateTypeMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("update_type_master")
}

model PrefectureMaster {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(2)
  name        String   @db.VarChar(10)
  name_kana   String?  @db.VarChar(20)
  sort_order  Int?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("prefecture_master")
}
