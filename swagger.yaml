openapi: 3.0.3
info:
  title: Cemetery CRM API
  description: 墓石管理システム（Cemetery Management System）のバックエンドAPI
  version: 1.0.0
  contact:
    name: Cemetery CRM Support

servers:
  - url: http://localhost:4000
    description: ローカル開発環境
  - url: http://localhost:4000/api/v1
    description: API v1 ベースURL

tags:
  - name: Auth
    description: 認証関連のエンドポイント
  - name: Plots
    description: 区画（墓石）管理
  - name: Masters
    description: マスターデータ
  - name: Staff
    description: スタッフ管理

paths:
  /api/v1/auth/login:
    post:
      tags:
        - Auth
      summary: ログイン
      description: メールアドレスとパスワードでログインし、JWTトークンを取得
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: password123
      responses:
        '200':
          description: ログイン成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      user:
                        $ref: '#/components/schemas/StaffPublic'
                      session:
                        type: object
                        properties:
                          access_token:
                            type: string
                          refresh_token:
                            type: string
                          expires_at:
                            type: integer
                            description: トークンの有効期限（UNIXタイムスタンプ）
                            example: 1704067200
        '401':
          $ref: '#/components/responses/Unauthorized'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'

# PlotエンドポイントのPath定義（ContractPlotモデル対応）
# この内容をswagger.yamlの /api/v1/plots セクションに置き換える

  /api/v1/plots:
    get:
      tags:
        - Plots
      summary: 契約区画一覧取得
      description: 契約区画の一覧を取得（検索・ページネーション対応）。物理区画と契約情報を含む。
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          description: ページ番号（1から開始）
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          description: 1ページあたりの件数
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: search
          in: query
          description: 検索キーワード（区画番号、顧客名で検索）
          schema:
            type: string
        - name: usageStatus
          in: query
          description: 使用状況フィルタ
          schema:
            type: string
        - name: cemeteryType
          in: query
          description: 墓地タイプフィルタ
          schema:
            type: string
      responses:
        '200':
          description: 取得成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ContractPlotSummary'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      tags:
        - Plots
      summary: 新規契約区画作成
      description: 物理区画と契約区画を同時に作成。顧客情報、販売契約、オプション情報も含む。
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePlotInput'
      responses:
        '201':
          description: 作成成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                        format: uuid
                        description: 作成されたContractPlotのID
                      message:
                        type: string
                        example: 契約区画を作成しました
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'

  /api/v1/plots/{id}:
    get:
      tags:
        - Plots
      summary: 契約区画詳細取得
      description: 指定した契約区画の詳細情報を取得。物理区画、顧客、販売契約、オプション情報を含む。
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: 契約区画ID（UUID）
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 取得成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/ContractPlotDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Plots
      summary: 契約区画更新
      description: 契約区画情報を更新。部分更新をサポート（contractPlot, saleContract, customer, workInfo, billingInfo, usageFee, managementFee）。
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: 契約区画ID（UUID）
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePlotInput'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                        format: uuid
                      message:
                        type: string
                        example: 契約区画を更新しました
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Plots
      summary: 契約区画削除（論理削除）
      description: 契約区画を論理削除。関連する販売契約、使用料、管理料、請求情報、勤務先情報も削除。顧客は他の契約がない場合のみ削除。物理区画のステータスは自動更新。
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: 契約区画ID（UUID）
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 削除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: 契約区画を削除しました
                      id:
                        type: string
                        format: uuid
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/v1/plots/{id}/contracts:
    get:
      tags:
        - Plots
      summary: 物理区画の契約一覧取得
      description: 指定した物理区画に紐づく全ての契約を取得。分割販売の場合、複数の契約が返される。
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: 物理区画ID（UUID）
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 取得成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/PhysicalPlotContracts'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    post:
      tags:
        - Plots
      summary: 物理区画に新規契約追加
      description: 既存の物理区画に新しい契約を追加（分割販売）。契約面積の検証を実施し、物理区画のステータスを自動更新。
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: 物理区画ID（UUID）
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePlotContractInput'
      responses:
        '201':
          description: 作成成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                        format: uuid
                        description: 作成されたContractPlotのID
                      message:
                        type: string
                        example: 契約を作成しました
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/v1/plots/{id}/inventory:
    get:
      tags:
        - Plots
      summary: 物理区画の在庫状況取得
      description: 物理区画の在庫状況を取得。総面積、割当済面積、利用可能面積、利用率、ステータスを返す。
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: 物理区画ID（UUID）
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 取得成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/PhysicalPlotInventory'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/v1/staff:
    get:
      tags:
        - Staff
      summary: スタッフ一覧取得
      description: スタッフの一覧を取得（ページネーション対応）。削除済みスタッフは含まれません。
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          description: ページ番号（1から開始）
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          description: 1ページあたりの件数
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: role
          in: query
          description: 役割でフィルタ
          schema:
            type: string
            enum: [viewer, operator, manager, admin]
        - name: is_active
          in: query
          description: アクティブ状態でフィルタ
          schema:
            type: boolean
      responses:
        '200':
          description: 取得成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      staff:
                        type: array
                        items:
                          $ref: '#/components/schemas/StaffAdmin'
                      pagination:
                        type: object
                        properties:
                          page:
                            type: integer
                            example: 1
                          limit:
                            type: integer
                            example: 20
                          total:
                            type: integer
                            example: 50
                          totalPages:
                            type: integer
                            example: 3
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      tags:
        - Staff
      summary: スタッフ新規登録
      description: |
        新しいスタッフを登録します。
        - Supabase Admin APIでユーザーを作成
        - 取得したsupabase_uidでStaffテーブルにレコード作成
        - トランザクション処理でロールバック対応
        - 管理者権限（admin）のみアクセス可能
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateStaffRequest'
      responses:
        '201':
          description: 作成成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/StaffAdmin'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'

  /api/v1/staff/{id}:
    get:
      tags:
        - Staff
      summary: スタッフ詳細取得
      description: 指定されたIDのスタッフ情報を取得
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: スタッフID
          schema:
            type: integer
            example: 1
      responses:
        '200':
          description: 取得成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/StaffAdmin'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Staff
      summary: スタッフ情報更新
      description: |
        スタッフ情報を更新します。
        - 名前、メールアドレス、役割の更新
        - Supabase側のメールアドレス更新も同期
        - 管理者権限（admin）のみアクセス可能
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: スタッフID
          schema:
            type: integer
            example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateStaffRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/StaffAdmin'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'

    delete:
      tags:
        - Staff
      summary: スタッフ削除（ソフトデリート）
      description: |
        スタッフを論理削除します。
        - deleted_atに現在日時を設定
        - is_activeをfalseに更新
        - 物理削除は行わない
        - 管理者権限（admin）のみアクセス可能
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: スタッフID
          schema:
            type: integer
            example: 1
      responses:
        '200':
          description: 削除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: スタッフを削除しました
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Supabaseから発行されたJWTトークンを使用

  schemas:
    # ==================== Staff スキーマ ====================

    Staff:
      type: object
      description: スタッフ情報（内部処理・DB操作用、APIレスポンスでは使用しない）
      properties:
        id:
          type: integer
          description: スタッフID
          example: 1
        supabase_uid:
          type: string
          description: Supabase User ID（内部管理用）
          example: "123e4567-e89b-12d3-a456-426614174000"
        name:
          type: string
          description: スタッフ名
          example: 山田太郎
          maxLength: 100
        email:
          type: string
          format: email
          description: メールアドレス
          example: yamada@example.com
          maxLength: 254
        role:
          type: string
          description: 役割
          enum: [viewer, operator, manager, admin]
          example: operator
        is_active:
          type: boolean
          description: アクティブ状態
          example: true
        last_login_at:
          type: string
          format: date-time
          description: 最終ログイン日時
          nullable: true
          example: "2024-01-01T12:00:00Z"
        created_at:
          type: string
          format: date-time
          description: 作成日時
          example: "2024-01-01T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: 更新日時
          example: "2024-01-01T12:00:00Z"

    StaffPublic:
      type: object
      description: スタッフ情報（一般公開用・認証レスポンス用）
      properties:
        id:
          type: integer
          description: スタッフID
          example: 1
        name:
          type: string
          description: スタッフ名
          example: 山田太郎
        email:
          type: string
          format: email
          description: メールアドレス
          example: yamada@example.com
        role:
          type: string
          description: 役割
          enum: [viewer, operator, manager, admin]
          example: operator
        is_active:
          type: boolean
          description: アクティブ状態
          example: true

    StaffAdmin:
      type: object
      description: スタッフ情報（管理者用・管理API用、supabase_uidを含まない）
      properties:
        id:
          type: integer
          description: スタッフID
          example: 1
        name:
          type: string
          description: スタッフ名
          example: 山田太郎
        email:
          type: string
          format: email
          description: メールアドレス
          example: yamada@example.com
        role:
          type: string
          description: 役割
          enum: [viewer, operator, manager, admin]
          example: operator
        is_active:
          type: boolean
          description: アクティブ状態
          example: true
        last_login_at:
          type: string
          format: date-time
          description: 最終ログイン日時
          nullable: true
          example: "2024-01-01T12:00:00Z"
        created_at:
          type: string
          format: date-time
          description: 作成日時
          example: "2024-01-01T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: 更新日時
          example: "2024-01-01T12:00:00Z"

    CreateStaffRequest:
      type: object
      description: スタッフ新規登録リクエスト
      required:
        - name
        - email
        - password
        - role
      properties:
        name:
          type: string
          description: スタッフ名
          example: 山田太郎
          minLength: 1
          maxLength: 100
        email:
          type: string
          format: email
          description: メールアドレス
          example: yamada@example.com
          maxLength: 254
        password:
          type: string
          format: password
          description: パスワード（8文字以上）
          example: SecurePass123!
          minLength: 8
        role:
          type: string
          description: 役割
          enum: [viewer, operator, manager, admin]
          example: operator
        is_active:
          type: boolean
          description: アクティブ状態
          default: true
          example: true

    UpdateStaffRequest:
      type: object
      description: スタッフ更新リクエスト（すべてのフィールドはオプション）
      properties:
        name:
          type: string
          description: スタッフ名
          example: 山田太郎
          minLength: 1
          maxLength: 100
        email:
          type: string
          format: email
          description: メールアドレス
          example: yamada@example.com
          maxLength: 254
        role:
          type: string
          description: 役割
          enum: [viewer, operator, manager, admin]
          example: manager
        is_active:
          type: boolean
          description: アクティブ状態
          example: true

    # ==================== レスポンススキーマ ====================

    ContractPlotSummary:
      type: object
      description: 契約区画のサマリー情報（一覧表示用）
      properties:
        id:
          type: string
          format: uuid
          description: 契約区画ID
          example: 123e4567-e89b-12d3-a456-426614174000
        plotNumber:
          type: string
          description: 区画番号
          example: A-01
        areaName:
          type: string
          description: 区域名
          example: 一般墓地A
        contractAreaSqm:
          type: number
          format: float
          description: 契約面積（㎡）
          example: 3.6
        customerName:
          type: string
          description: 顧客名
          example: 山田太郎
        saleStatus:
          type: string
          description: 販売ステータス
          example: completed
        contractDate:
          type: string
          format: date
          description: 契約日
          example: "2024-01-01"
        price:
          type: number
          description: 価格
          example: 1000000

    ContractPlotDetail:
      type: object
      description: 契約区画の詳細情報
      properties:
        id:
          type: string
          format: uuid
          description: 契約区画ID
        contractAreaSqm:
          type: number
          format: float
          description: 契約面積（㎡）
        saleStatus:
          type: string
          description: 販売ステータス
          nullable: true
        locationDescription:
          type: string
          description: 位置説明
          nullable: true
        PhysicalPlot:
          $ref: '#/components/schemas/PhysicalPlotInfo'
        SaleContract:
          $ref: '#/components/schemas/SaleContractInfo'
        UsageFee:
          $ref: '#/components/schemas/UsageFeeInfo'
          nullable: true
        ManagementFee:
          $ref: '#/components/schemas/ManagementFeeInfo'
          nullable: true

    PhysicalPlotInfo:
      type: object
      description: 物理区画情報
      properties:
        id:
          type: string
          format: uuid
        plotNumber:
          type: string
          description: 区画番号
          example: A-01
        areaName:
          type: string
          description: 区域名
          example: 一般墓地A
        areaSqm:
          type: number
          format: float
          description: 面積（㎡）
          example: 3.6
        status:
          type: string
          description: 物理区画ステータス
          enum: [available, partial, sold_out]
          example: sold_out
        notes:
          type: string
          nullable: true
        BuriedPersons:
          type: array
          items:
            $ref: '#/components/schemas/BuriedPersonInfo'
        CollectiveBurials:
          type: array
          items:
            $ref: '#/components/schemas/CollectiveBurialInfo'
        FamilyContacts:
          type: array
          items:
            $ref: '#/components/schemas/FamilyContactInfo'

    SaleContractInfo:
      type: object
      description: 販売契約情報
      properties:
        id:
          type: string
          format: uuid
        contractDate:
          type: string
          format: date
          example: "2024-01-01"
        price:
          type: number
          example: 1000000
        paymentStatus:
          type: string
          nullable: true
        customerRole:
          type: string
          nullable: true
        reservationDate:
          type: string
          format: date
          nullable: true
        acceptanceNumber:
          type: string
          nullable: true
        permitDate:
          type: string
          format: date
          nullable: true
        startDate:
          type: string
          format: date
          nullable: true
        notes:
          type: string
          nullable: true
        Customer:
          $ref: '#/components/schemas/CustomerInfo'

    CustomerInfo:
      type: object
      description: 顧客情報
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: 山田太郎
        nameKana:
          type: string
          example: ヤマダタロウ
        birthDate:
          type: string
          format: date
          nullable: true
        gender:
          type: string
          enum: [male, female, other]
          nullable: true
        postalCode:
          type: string
          example: "150-0001"
        address:
          type: string
          example: 東京都渋谷区
        registeredAddress:
          type: string
          nullable: true
        phoneNumber:
          type: string
          example: "03-1234-5678"
          nullable: true
        faxNumber:
          type: string
          nullable: true
        email:
          type: string
          format: email
          nullable: true
        notes:
          type: string
          nullable: true
        WorkInfo:
          $ref: '#/components/schemas/WorkInfoInfo'
          nullable: true
        BillingInfo:
          $ref: '#/components/schemas/BillingInfoInfo'
          nullable: true

    WorkInfoInfo:
      type: object
      description: 勤務先情報
      properties:
        id:
          type: string
          format: uuid
        companyName:
          type: string
        companyNameKana:
          type: string
        workPostalCode:
          type: string
          nullable: true
        workAddress:
          type: string
          nullable: true
        workPhoneNumber:
          type: string
          nullable: true
        dmSetting:
          type: string
        addressType:
          type: string
        notes:
          type: string
          nullable: true

    BillingInfoInfo:
      type: object
      description: 請求情報
      properties:
        id:
          type: string
          format: uuid
        billingType:
          type: string
          nullable: true
        accountType:
          type: string
          nullable: true
        bankName:
          type: string
          nullable: true
        branchName:
          type: string
          nullable: true
        accountNumber:
          type: string
          nullable: true
        accountHolder:
          type: string
          nullable: true

    UsageFeeInfo:
      type: object
      description: 使用料情報
      properties:
        id:
          type: string
          format: uuid
        calculationType:
          type: string
          nullable: true
        taxType:
          type: string
          nullable: true
        billingType:
          type: string
          nullable: true
        billingYears:
          type: string
          nullable: true
        area:
          type: string
          nullable: true
        unitPrice:
          type: string
          nullable: true
        usageFee:
          type: string
          nullable: true
        paymentMethod:
          type: string
          nullable: true

    ManagementFeeInfo:
      type: object
      description: 管理料情報
      properties:
        id:
          type: string
          format: uuid
        calculationType:
          type: string
          nullable: true
        taxType:
          type: string
          nullable: true
        billingType:
          type: string
          nullable: true
        billingYears:
          type: string
          nullable: true
        area:
          type: string
          nullable: true
        billingMonth:
          type: string
          nullable: true
        managementFee:
          type: string
          nullable: true
        unitPrice:
          type: string
          nullable: true
        lastBillingMonth:
          type: string
          nullable: true
        paymentMethod:
          type: string
          nullable: true

    BuriedPersonInfo:
      type: object
      description: 埋葬者情報
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          nullable: true
        nameKana:
          type: string
          nullable: true
        relationship:
          type: string
          nullable: true
        deathDate:
          type: string
          format: date
          nullable: true
        age:
          type: integer
          nullable: true
        gender:
          type: string
          enum: [male, female, other]
          nullable: true
        burialDate:
          type: string
          format: date
          nullable: true
        graveNumber:
          type: string
          nullable: true
        notes:
          type: string
          nullable: true

    CollectiveBurialInfo:
      type: object
      description: 合祀情報
      properties:
        id:
          type: string
          format: uuid
        burialType:
          type: string
        requestDate:
          type: string
          format: date
          nullable: true
        executionDate:
          type: string
          format: date
          nullable: true
        status:
          type: string
        notes:
          type: string
          nullable: true

    FamilyContactInfo:
      type: object
      description: 家族連絡先情報
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          nullable: true
        birthDate:
          type: string
          format: date
          nullable: true
        relationship:
          type: string
          nullable: true
        address:
          type: string
          nullable: true
        phoneNumber:
          type: string
          nullable: true
        email:
          type: string
          format: email
          nullable: true

    PhysicalPlotContracts:
      type: object
      description: 物理区画の契約一覧情報
      properties:
        physicalPlot:
          type: object
          properties:
            id:
              type: string
              format: uuid
            plotNumber:
              type: string
              example: A-01
            areaName:
              type: string
              example: 一般墓地A
            areaSqm:
              type: number
              format: float
              example: 3.6
            status:
              type: string
              enum: [available, partial, sold_out]
        contracts:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              contractAreaSqm:
                type: number
                format: float
              saleStatus:
                type: string
                nullable: true
              customerName:
                type: string
              contractDate:
                type: string
                format: date
              price:
                type: number
        summary:
          type: object
          properties:
            totalContracts:
              type: integer
              description: 契約総数
              example: 2
            totalAllocatedArea:
              type: number
              format: float
              description: 割当済総面積（㎡）
              example: 3.6

    PhysicalPlotInventory:
      type: object
      description: 物理区画の在庫情報
      properties:
        physicalPlot:
          type: object
          properties:
            id:
              type: string
              format: uuid
            plotNumber:
              type: string
              example: A-01
            areaName:
              type: string
              example: 一般墓地A
            areaSqm:
              type: number
              format: float
              example: 3.6
        inventory:
          type: object
          properties:
            totalArea:
              type: number
              format: float
              description: 総面積（㎡）
              example: 3.6
            allocatedArea:
              type: number
              format: float
              description: 割当済面積（㎡）
              example: 1.8
            availableArea:
              type: number
              format: float
              description: 利用可能面積（㎡）
              example: 1.8
            utilizationRate:
              type: number
              format: float
              description: 利用率（%）
              example: 50.0
            status:
              type: string
              enum: [available, partial, sold_out]
              description: 在庫ステータス
              example: partial
        contracts:
          type: array
          description: 既存契約一覧
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              contractAreaSqm:
                type: number
                format: float
              saleStatus:
                type: string
                nullable: true
              customerName:
                type: string

    # ==================== リクエストスキーマ ====================

    CreatePlotInput:
      type: object
      description: 新規契約区画作成リクエスト
      required:
        - physicalPlot
        - contractPlot
        - saleContract
        - customer
      properties:
        physicalPlot:
          type: object
          required:
            - plotNumber
            - areaName
            - areaSqm
          properties:
            plotNumber:
              type: string
              description: 区画番号（大文字英数字とハイフンのみ）
              pattern: '^[A-Z0-9-]+$'
              maxLength: 50
              example: A-01
            areaName:
              type: string
              description: 区域名
              maxLength: 100
              example: 一般墓地A
            areaSqm:
              type: number
              format: float
              description: 面積（㎡）
              minimum: 0.01
              example: 3.6
            notes:
              type: string
              maxLength: 1000
              nullable: true
        contractPlot:
          type: object
          required:
            - contractAreaSqm
          properties:
            contractAreaSqm:
              type: number
              format: float
              description: 契約面積（㎡）
              minimum: 0.01
              example: 3.6
            saleStatus:
              type: string
              maxLength: 50
              nullable: true
              example: completed
            locationDescription:
              type: string
              maxLength: 200
              nullable: true
              example: 南側
        saleContract:
          type: object
          required:
            - contractDate
            - price
          properties:
            contractDate:
              type: string
              format: date
              description: 契約日
              example: "2024-01-01"
            price:
              type: number
              description: 価格
              minimum: 0
              example: 1000000
            paymentStatus:
              type: string
              maxLength: 50
              nullable: true
            customerRole:
              type: string
              maxLength: 50
              nullable: true
            reservationDate:
              type: string
              format: date
              nullable: true
            acceptanceNumber:
              type: string
              maxLength: 50
              nullable: true
            permitDate:
              type: string
              format: date
              nullable: true
            startDate:
              type: string
              format: date
              nullable: true
            notes:
              type: string
              maxLength: 1000
              nullable: true
        customer:
          type: object
          required:
            - name
            - nameKana
            - postalCode
            - address
          properties:
            name:
              type: string
              description: 顧客名
              minLength: 1
              maxLength: 100
              example: 山田太郎
            nameKana:
              type: string
              description: 顧客名カナ（カタカナのみ）
              pattern: '^[ァ-ヶー\s]+$'
              maxLength: 100
              example: ヤマダタロウ
            birthDate:
              type: string
              format: date
              nullable: true
            gender:
              type: string
              enum: [male, female, other]
              nullable: true
            postalCode:
              type: string
              description: 郵便番号
              minLength: 1
              maxLength: 10
              example: "150-0001"
            address:
              type: string
              description: 住所
              minLength: 1
              maxLength: 200
              example: 東京都渋谷区
            registeredAddress:
              type: string
              maxLength: 200
              nullable: true
            phoneNumber:
              type: string
              pattern: '^0\d{1,4}-?\d{1,4}-?\d{4}$'
              nullable: true
              example: "03-1234-5678"
            faxNumber:
              type: string
              pattern: '^0\d{1,4}-?\d{1,4}-?\d{4}$'
              nullable: true
            email:
              type: string
              format: email
              nullable: true
            notes:
              type: string
              maxLength: 1000
              nullable: true
        workInfo:
          type: object
          nullable: true
          properties:
            workPostalCode:
              type: string
              maxLength: 10
              nullable: true
            workAddress:
              type: string
              maxLength: 200
              nullable: true
            workPhoneNumber:
              type: string
              pattern: '^0\d{1,4}-?\d{1,4}-?\d{4}$'
              nullable: true
            workFaxNumber:
              type: string
              pattern: '^0\d{1,4}-?\d{1,4}-?\d{4}$'
              nullable: true
        billingInfo:
          type: object
          nullable: true
          properties:
            billingType:
              type: string
              maxLength: 50
              nullable: true
            accountType:
              type: string
              maxLength: 50
              nullable: true
            bankName:
              type: string
              maxLength: 100
              nullable: true
            branchName:
              type: string
              maxLength: 100
              nullable: true
            accountNumber:
              type: string
              maxLength: 20
              nullable: true
            accountHolder:
              type: string
              maxLength: 100
              nullable: true
        usageFee:
          type: object
          nullable: true
          properties:
            calculationType:
              type: string
              maxLength: 50
              nullable: true
            taxType:
              type: string
              maxLength: 50
              nullable: true
            billingType:
              type: string
              maxLength: 50
              nullable: true
            billingYears:
              type: string
              maxLength: 50
              nullable: true
            area:
              type: string
              maxLength: 50
              nullable: true
            unitPrice:
              type: string
              maxLength: 50
              nullable: true
            usageFee:
              type: string
              maxLength: 50
              nullable: true
            paymentMethod:
              type: string
              maxLength: 50
              nullable: true
        managementFee:
          type: object
          nullable: true
          properties:
            calculationType:
              type: string
              maxLength: 50
              nullable: true
            taxType:
              type: string
              maxLength: 50
              nullable: true
            billingType:
              type: string
              maxLength: 50
              nullable: true
            billingYears:
              type: string
              maxLength: 50
              nullable: true
            area:
              type: string
              maxLength: 50
              nullable: true
            billingMonth:
              type: string
              maxLength: 50
              nullable: true
            managementFee:
              type: string
              maxLength: 50
              nullable: true
            unitPrice:
              type: string
              maxLength: 50
              nullable: true
            lastBillingMonth:
              type: string
              pattern: '^\d{4}年\d{1,2}月$'
              nullable: true
              example: "2024年3月"
            paymentMethod:
              type: string
              maxLength: 50
              nullable: true

    UpdatePlotInput:
      type: object
      description: 契約区画更新リクエスト（全フィールドオプション）
      properties:
        contractPlot:
          type: object
          properties:
            contractAreaSqm:
              type: number
              format: float
              minimum: 0.01
            saleStatus:
              type: string
              maxLength: 50
              nullable: true
            locationDescription:
              type: string
              maxLength: 200
              nullable: true
        saleContract:
          type: object
          properties:
            contractDate:
              type: string
              format: date
            price:
              type: number
              minimum: 0
            paymentStatus:
              type: string
              maxLength: 50
              nullable: true
            customerRole:
              type: string
              maxLength: 50
              nullable: true
            reservationDate:
              type: string
              format: date
              nullable: true
            acceptanceNumber:
              type: string
              maxLength: 50
              nullable: true
            permitDate:
              type: string
              format: date
              nullable: true
            startDate:
              type: string
              format: date
              nullable: true
            notes:
              type: string
              maxLength: 1000
              nullable: true
        customer:
          type: object
          properties:
            name:
              type: string
              maxLength: 100
            nameKana:
              type: string
              pattern: '^[ァ-ヶー\s]+$'
              maxLength: 100
            birthDate:
              type: string
              format: date
              nullable: true
            gender:
              type: string
              enum: [male, female, other]
              nullable: true
            postalCode:
              type: string
              maxLength: 10
            address:
              type: string
              maxLength: 200
            registeredAddress:
              type: string
              maxLength: 200
              nullable: true
            phoneNumber:
              type: string
              pattern: '^0\d{1,4}-?\d{1,4}-?\d{4}$'
              nullable: true
            faxNumber:
              type: string
              pattern: '^0\d{1,4}-?\d{1,4}-?\d{4}$'
              nullable: true
            email:
              type: string
              format: email
              nullable: true
            notes:
              type: string
              maxLength: 1000
              nullable: true
        workInfo:
          type: object
          nullable: true
          properties:
            workPostalCode:
              type: string
              maxLength: 10
              nullable: true
            workAddress:
              type: string
              maxLength: 200
              nullable: true
            workPhoneNumber:
              type: string
              pattern: '^0\d{1,4}-?\d{1,4}-?\d{4}$'
              nullable: true
            workFaxNumber:
              type: string
              pattern: '^0\d{1,4}-?\d{1,4}-?\d{4}$'
              nullable: true
        billingInfo:
          type: object
          nullable: true
          properties:
            billingType:
              type: string
              maxLength: 50
              nullable: true
            accountType:
              type: string
              maxLength: 50
              nullable: true
            bankName:
              type: string
              maxLength: 100
              nullable: true
            branchName:
              type: string
              maxLength: 100
              nullable: true
            accountNumber:
              type: string
              maxLength: 20
              nullable: true
            accountHolder:
              type: string
              maxLength: 100
              nullable: true
        usageFee:
          type: object
          nullable: true
          properties:
            calculationType:
              type: string
              maxLength: 50
              nullable: true
            taxType:
              type: string
              maxLength: 50
              nullable: true
            billingType:
              type: string
              maxLength: 50
              nullable: true
            billingYears:
              type: string
              maxLength: 50
              nullable: true
            area:
              type: string
              maxLength: 50
              nullable: true
            unitPrice:
              type: string
              maxLength: 50
              nullable: true
            usageFee:
              type: string
              maxLength: 50
              nullable: true
            paymentMethod:
              type: string
              maxLength: 50
              nullable: true
        managementFee:
          type: object
          nullable: true
          properties:
            calculationType:
              type: string
              maxLength: 50
              nullable: true
            taxType:
              type: string
              maxLength: 50
              nullable: true
            billingType:
              type: string
              maxLength: 50
              nullable: true
            billingYears:
              type: string
              maxLength: 50
              nullable: true
            area:
              type: string
              maxLength: 50
              nullable: true
            billingMonth:
              type: string
              maxLength: 50
              nullable: true
            managementFee:
              type: string
              maxLength: 50
              nullable: true
            unitPrice:
              type: string
              maxLength: 50
              nullable: true
            lastBillingMonth:
              type: string
              pattern: '^\d{4}年\d{1,2}月$'
              nullable: true
            paymentMethod:
              type: string
              maxLength: 50
              nullable: true

    CreatePlotContractInput:
      type: object
      description: 物理区画への新規契約追加リクエスト（physicalPlot不要）
      required:
        - contractPlot
        - saleContract
        - customer
      properties:
        contractPlot:
          type: object
          required:
            - contractAreaSqm
          properties:
            contractAreaSqm:
              type: number
              format: float
              description: 契約面積（㎡）
              minimum: 0.01
              example: 1.8
            saleStatus:
              type: string
              maxLength: 50
              nullable: true
            locationDescription:
              type: string
              maxLength: 200
              nullable: true
        saleContract:
          type: object
          required:
            - contractDate
            - price
          properties:
            contractDate:
              type: string
              format: date
              example: "2024-06-01"
            price:
              type: number
              minimum: 0
              example: 500000
            paymentStatus:
              type: string
              maxLength: 50
              nullable: true
            customerRole:
              type: string
              maxLength: 50
              nullable: true
            reservationDate:
              type: string
              format: date
              nullable: true
            acceptanceNumber:
              type: string
              maxLength: 50
              nullable: true
            permitDate:
              type: string
              format: date
              nullable: true
            startDate:
              type: string
              format: date
              nullable: true
            notes:
              type: string
              maxLength: 1000
              nullable: true
        customer:
          type: object
          required:
            - name
            - nameKana
            - postalCode
            - address
          properties:
            name:
              type: string
              minLength: 1
              maxLength: 100
              example: 田中花子
            nameKana:
              type: string
              pattern: '^[ァ-ヶー\s]+$'
              maxLength: 100
              example: タナカハナコ
            birthDate:
              type: string
              format: date
              nullable: true
            gender:
              type: string
              enum: [male, female, other]
              nullable: true
            postalCode:
              type: string
              minLength: 1
              maxLength: 10
              example: "150-0002"
            address:
              type: string
              minLength: 1
              maxLength: 200
              example: 東京都渋谷区
            registeredAddress:
              type: string
              maxLength: 200
              nullable: true
            phoneNumber:
              type: string
              pattern: '^0\d{1,4}-?\d{1,4}-?\d{4}$'
              nullable: true
            faxNumber:
              type: string
              pattern: '^0\d{1,4}-?\d{1,4}-?\d{4}$'
              nullable: true
            email:
              type: string
              format: email
              nullable: true
            notes:
              type: string
              maxLength: 1000
              nullable: true
        workInfo:
          type: object
          nullable: true
        billingInfo:
          type: object
          nullable: true
        usageFee:
          type: object
          nullable: true
        managementFee:
          type: object
          nullable: true
    Pagination:
      type: object
      properties:
        total:
          type: integer
          example: 100
        page:
          type: integer
          example: 1
        limit:
          type: integer
          example: 20
        totalPages:
          type: integer
          example: 5

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              example: VALIDATION_ERROR
            message:
              type: string
              example: バリデーションエラーが発生しました
            details:
              type: array
              items:
                type: object
                properties:
                  field:
                    type: string
                    example: plot.plotNumber
                  message:
                    type: string
                    example: 区画番号は必須です

  responses:
    BadRequest:
      description: バリデーションエラー
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: VALIDATION_ERROR
              message: バリデーションエラーが発生しました
              details:
                - field: plot.plotNumber
                  message: 区画番号は必須です

    Unauthorized:
      description: 認証エラー
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: UNAUTHORIZED
              message: 認証が必要です
              details: []

    Forbidden:
      description: 権限エラー
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: FORBIDDEN
              message: この操作を実行する権限がありません
              details: []

    NotFound:
      description: リソースが見つからない
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: NOT_FOUND
              message: 指定されたリソースが見つかりません
              details: []

    Conflict:
      description: データ競合エラー
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: CONFLICT
              message: 区画番号が既に存在します
              details: []

    ServiceUnavailable:
      description: サービス利用不可
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: SERVICE_UNAVAILABLE
              message: Supabase認証サービスが利用できません
              details: []
